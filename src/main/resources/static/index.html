<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Accounts</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body class="bg-light">
<div class="container py-4">
    <div class="card shadow-sm">
        <div class="card-body">
            <h4 class="mb-3">Accounts and Transactions</h4>

            <table class="table table-sm table-hover align-middle mb-0">
                <thead class="table-light">
                <tr><th>account id</th><th>first name</th><th>last name</th><th>balance</th><th>created at</th></tr>
                </thead>
                <tbody id="rows"></tbody>
            </table>

            <div class="d-flex justify-content-between align-items-center mt-3">
                <button id="acc-prev" class="btn btn-outline-primary btn-sm">Previous</button>
                <span id="acc-page-info" class="small font-monospace">Page 1</span>
                <button id="acc-next" class="btn btn-outline-primary btn-sm">Next</button>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mt-4">
        <div class="card-body">
            <h4 class="mb-3">Create Account</h4>
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="acc-firstName" class="form-label">First Name</label>
                    <input type="text" id="acc-firstName" class="form-control form-control-sm" placeholder="First Name">
                </div>
                <div class="col-md-4">
                    <label for="acc-lastName" class="form-label">Last Name</label>
                    <input type="text" id="acc-lastName" class="form-control form-control-sm" placeholder="Last Name">
                </div>
                <div class="col-md-4">
                    <label for="acc-balance" class="form-label">Initial Balance</label>
                    <input type="number" id="acc-balance" class="form-control form-control-sm" step="0.01" value="0.00">
                </div>
                <div class="col-12">
                    <button id="create-acc" class="btn btn-success btn-sm">Create Account</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mt-4">
        <div class="card-body">
            <h4 class="mb-3">Transactions</h4>

            <div class="row g-3 mb-3">
                <div class="col-md-4">
                    <label for="view-tx-accountIds" class="form-label">Account IDs</label>
                    <select id="view-tx-accountIds" class="form-select form-select-sm" multiple size="3">
                    </select>
                    <div class="form-text small">
                        Hold Ctrl/Cmd for multi-select. Leave empty for all.
                    </div>
                </div>
            </div>

            <table class="table table-sm table-hover align-middle mb-0">
                <thead class="table-light">
                <tr><th>tx id</th><th>account id</th><th>type</th><th>amount</th><th>created at</th></tr>
                </thead>
                <tbody id="tx-rows"></tbody>
            </table>

            <div class="d-flex justify-content-between align-items-center mt-3">
                <button id="tx-prev" class="btn btn-outline-primary btn-sm">Previous</button>
                <span id="tx-page-info" class="small font-monospace">Page 1</span>
                <button id="tx-next" class="btn btn-outline-primary btn-sm">Next</button>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mt-4">
        <div class="card-body">
            <h4 class="mb-3">Create Transaction</h4>
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="tx-accountId" class="form-label">Account ID</label>
                    <select id="tx-accountId" class="form-select form-select-sm">
                        <option value="">-- Select Account --</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="tx-type" class="form-label">Type</label>
                    <select id="tx-type" class="form-select form-select-sm">
                        <option value="DEPOSIT">DEPOSIT</option>
                        <option value="WITHDRAWAL">WITHDRAWAL</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="tx-amount" class="form-label">Amount</label>
                    <input type="number" id="tx-amount" class="form-control form-control-sm" step="0.01" value="0.00">
                </div>
                <div class="col-12">
                    <button id="create-tx" class="btn btn-success btn-sm">Create Transaction</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let accPage = 0;
    let txPage = 0;
    const pageSize = 10;

    const rows = document.getElementById("rows");
    const txRows = document.getElementById("tx-rows");
    const viewTxAccountIdsSelect = document.getElementById("view-tx-accountIds");
    const createTxAccountIdSelect = document.getElementById("tx-accountId");
    const accPageInfo = document.getElementById("acc-page-info");
    const txPageInfo = document.getElementById("tx-page-info");

    async function loadAccounts() {
        const res = await fetch(`/accounts?limit=${pageSize}&offset=${accPage * pageSize}`);
        const accounts = await res.json();

        rows.innerHTML = accounts.map(a => `
      <tr>
        <td class="text-muted small">${a.accountId}</td>
        <td>${a.firstName}</td>
        <td>${a.lastName}</td>
        <td>${Number(a.balance).toFixed(2)}</td>
        <td class="small">${a.createdAt ?? "-"}</td>
      </tr>
    `).join("");

        accPageInfo.innerText = `Page ${accPage + 1}`;
        document.getElementById("acc-prev").disabled = accPage === 0;
        document.getElementById("acc-next").disabled = accounts.length < pageSize;

        // Also refresh dropdowns with a larger set of accounts
        const resAll = await fetch(`/accounts?limit=100`);
        const allAccounts = await resAll.json();
        updateDropdowns(allAccounts);
    }

    function updateDropdowns(accounts) {
        const options = accounts.map(a => `<option value="${a.accountId}">${a.firstName} ${a.lastName} (${a.accountId.substring(0,8)}...)</option>`).join("");

        const selected = new Set(Array.from(viewTxAccountIdsSelect.selectedOptions).map(o => o.value));
        viewTxAccountIdsSelect.innerHTML = options;
        for (const opt of viewTxAccountIdsSelect.options) opt.selected = selected.has(opt.value);

        const currentCreate = createTxAccountIdSelect.value;
        createTxAccountIdSelect.innerHTML = `<option value="">-- Select Account --</option>` + options;
        createTxAccountIdSelect.value = currentCreate;
    }

    async function fetchTransactions() {
        const csv = Array.from(viewTxAccountIdsSelect.selectedOptions).map(o => o.value).join(",");
        const url = new URL("/transactions", window.location.origin);
        if (csv) url.searchParams.set("accountIds", csv);
        url.searchParams.set("limit", pageSize);
        url.searchParams.set("offset", txPage * pageSize);

        const res = await fetch(url);
        const transactions = await res.json();

        txRows.innerHTML = transactions.map(tx => `
      <tr>
        <td class="text-muted small">${tx.id ?? "-"}</td>
        <td class="text-muted small">${tx.accountId ?? "-"}</td>
        <td><span class="badge ${tx.txType === 'DEPOSIT' ? 'bg-success' : 'bg-danger'}">${tx.txType}</span></td>
        <td>${Number(tx.amount).toFixed(2)}</td>
        <td class="small">${tx.createdAt ?? "-"}</td>
      </tr>
    `).join("");

        txPageInfo.innerText = `Page ${txPage + 1}`;
        document.getElementById("tx-prev").disabled = txPage === 0;
        document.getElementById("tx-next").disabled = transactions.length < pageSize;
    }

    document.getElementById("acc-prev").onclick = () => { if (accPage > 0) { accPage--; loadAccounts(); } };
    document.getElementById("acc-next").onclick = () => { accPage++; loadAccounts(); };
    document.getElementById("tx-prev").onclick = () => { if (txPage > 0) { txPage--; fetchTransactions(); } };
    document.getElementById("tx-next").onclick = () => { txPage++; fetchTransactions(); };

    document.getElementById("view-tx-accountIds").onchange = () => { txPage = 0; fetchTransactions(); };

    document.getElementById("create-acc").onclick = async () => {
        const firstName = document.getElementById("acc-firstName").value;
        const lastName = document.getElementById("acc-lastName").value;
        const balance = document.getElementById("acc-balance").value;

        if (!firstName || !lastName) return alert("First and Last names are required");

        const response = await fetch("/accounts", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ firstName, lastName, balance: parseFloat(balance) })
        });

        if (!response.ok) return alert("Error creating account");
        
        document.getElementById("acc-firstName").value = "";
        document.getElementById("acc-lastName").value = "";
        document.getElementById("acc-balance").value = "0.00";

        accPage = 0;
        await loadAccounts();
    };

    document.getElementById("create-tx").onclick = async () => {
        const accountId = createTxAccountIdSelect.value;
        const txType = document.getElementById("tx-type").value;
        const amount = document.getElementById("tx-amount").value;

        if (!accountId) return alert("Please select Account ID");

        const response = await fetch("/transactions", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ accountId, txType, amount: parseFloat(amount) })
        });

        if (!response.ok) return alert("Error creating transaction");
        txPage = 0;
        await fetchTransactions();
    };

    loadAccounts();
    fetchTransactions();
</script>
</body>
</html>
